<h4 *ngIf="lat && lon" class="text-center card">Latitude: {{ lat | number }}, Longitude: {{ lon | number }}</h4>
<h4 *ngIf="!lat || !lon" class="text-center card text-orange-500">Selecione um ponto no mapa ou envie um GeoJSON pelo topbar</h4>

<p-card>
    <div class="flex flex-wrap gap-3 align-items-end">
        <span class="flex flex-column">
            <label for="layer-select" class="mb-1 font-semibold">Layer</label>
            <p-selectButton
                id="layer-select"
                [options]="layers"
                [(ngModel)]="selectedLayer"
                optionLabel="label"
                optionValue="value"
                (onChange)="onLayerChange()"
            ></p-selectButton>
        </span>

        <span class="flex flex-column">
            <label for="start-date" class="mb-1 font-semibold">Data Inicial</label>
            <p-calendar
                id="start-date"
                [(ngModel)]="startDate"
                dateFormat="yy-mm-dd"
                [showIcon]="true"
                appendTo="body"
                (onSelect)="onFilterChange()"
                (onClose)="onCalendarClose()"
            ></p-calendar>
        </span>

        <span class="flex flex-column">
            <label for="end-date" class="mb-1 font-semibold">Data Final</label>
            <p-calendar
                id="end-date"
                [(ngModel)]="endDate"
                dateFormat="yy-mm-dd"
                [showIcon]="true"
                appendTo="body"
                (onSelect)="onFilterChange()"
                (onClose)="onCalendarClose()"
            ></p-calendar>
        </span>

        <span class="flex flex-column">
            <label class="mb-1 font-semibold">Max Cloud: {{ maxCloud }}%</label>
            <p-slider
                [(ngModel)]="maxCloud"
                [min]="0"
                [max]="100"
                [style]="{'width': '150px'}"
                (onSlideEnd)="onFilterChange()"
            ></p-slider>
        </span>

        <span class="flex flex-column">
            <label for="buffer-input" class="mb-1 font-semibold">Buffer</label>
            <p-inputNumber
                id="buffer-input"
                [(ngModel)]="bufferMeters"
                [min]="100"
                [max]="10000"
                [step]="100"
                suffix=" m"
                [style]="{'width': '120px'}"
                (onBlur)="onFilterChange()"
            ></p-inputNumber>
        </span>

        <span class="flex flex-column">
            <label for="visparam-select" class="mb-1 font-semibold">Vis Param</label>
            <p-selectButton
                id="visparam-select"
                [options]="currentVisparamOptions"
                [(ngModel)]="selectedVisparam"
                optionLabel="label"
                optionValue="value"
                (onChange)="onFilterChange()"
            ></p-selectButton>
        </span>

        <span class="flex flex-column">
            <label for="sort-select" class="mb-1 font-semibold">Ordenar</label>
            <p-selectButton
                id="sort-select"
                [options]="sortOptions"
                [(ngModel)]="selectedSort"
                optionLabel="label"
                optionValue="value"
                (onChange)="onFilterChange()"
            ></p-selectButton>
        </span>

        <button
            pButton
            label="Buscar"
            icon="pi pi-search"
            (click)="offset = 0; searchCatalog()"
            [disabled]="!lat || !lon || !startDate || !endDate"
            [loading]="loading"
        ></button>

        <app-screen-state-clear
            screenKey="image-catalog"
            (cleared)="clearFilters()"
        ></app-screen-state-clear>
    </div>
</p-card>

<div class="mt-3" *ngIf="loading">
    <div class="flex justify-content-center">
        <p-progressSpinner strokeWidth="4" [style]="{'width': '50px', 'height': '50px'}"></p-progressSpinner>
    </div>
</div>

<p-messages
    *ngIf="errorMessage"
    [value]="[{severity: 'error', summary: 'Erro', detail: errorMessage}]"
    [closable]="true"
    class="mt-3"
></p-messages>

<p-card class="mt-3" *ngIf="searched && !loading && !errorMessage">
    <div class="flex justify-content-between align-items-center mb-2">
        <span class="font-semibold">
            {{ totalImages }} imagens encontradas
            <p-badge
                *ngIf="selectedImages.length > 0"
                [value]="selectedImages.length + ' selecionadas'"
                severity="info"
                class="ml-2"
            ></p-badge>
        </span>
        <button
            pButton
            label="Limpar Seleção ({{ selectedImages.length }})"
            icon="pi pi-times"
            class="p-button-outlined p-button-secondary"
            (click)="clearSelection()"
            *ngIf="selectedImages.length > 0"
        ></button>
    </div>

    <p-table
        [value]="catalogItems"
        [rows]="limit"
        [totalRecords]="totalImages"
        [loading]="loading"
        [paginator]="true"
        [lazy]="true"
        [lazyLoadOnInit]="false"
        (onLazyLoad)="onPageChange($event)"
        [rowsPerPageOptions]="[25, 50, 100]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} imagens"
        [first]="offset"
        styleClass="p-datatable-sm"
        *ngIf="catalogItems.length > 0"
    >
        <ng-template pTemplate="header">
            <tr>
                <th style="width: 3rem">
                    <p-checkbox
                        [binary]="true"
                        [ngModel]="isAllPageSelected"
                        (onChange)="toggleSelectAll()"
                    ></p-checkbox>
                </th>
                <th>Data</th>
                <th>Cloud %</th>
                <th>Plataforma</th>
                <th>ID</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
            <tr>
                <td>
                    <p-checkbox
                        [binary]="true"
                        [ngModel]="item.selected"
                        (onChange)="onImageSelect(item)"
                    ></p-checkbox>
                </td>
                <td>{{ formatDateDisplay(item.datetime) }}</td>
                <td>
                    <p-tag
                        *ngIf="item.cloud !== null"
                        [value]="item.cloud.toFixed(1) + '%'"
                        [severity]="getCloudSeverity(item.cloud)"
                    ></p-tag>
                    <span *ngIf="item.cloud === null">N/A</span>
                </td>
                <td>{{ item.platform }}</td>
                <td
                    class="text-overflow-ellipsis"
                    style="max-width: 300px; overflow: hidden; white-space: nowrap;"
                    [pTooltip]="item.id"
                    tooltipPosition="top"
                >
                    {{ item.id }}
                </td>
            </tr>
        </ng-template>
    </p-table>

    <div *ngIf="catalogItems.length === 0 && !loading" class="text-center p-4 text-500">
        Nenhuma imagem encontrada para os critérios selecionados.
    </div>
</p-card>

<div class="mt-3" *ngIf="selectedImages.length > 0">
    <h5>Imagens Selecionadas ({{ selectedImages.length }})</h5>
    <div class="map-grid">
        <div *ngFor="let img of selectedImages" class="map-item">
            <div class="map-label">
                <span class="font-semibold">{{ formatDateDisplay(img.datetime) }}</span>
                <p-tag
                    *ngIf="img.cloud !== null"
                    [value]="'Cloud: ' + img.cloud.toFixed(1) + '%'"
                    [severity]="getCloudSeverity(img.cloud)"
                    class="ml-2"
                ></p-tag>
                <button
                    pButton
                    pRipple
                    icon="pi pi-times"
                    class="p-button-rounded p-button-danger p-button-text p-button-sm ml-2"
                    (click)="removeSelectedImage(img)"
                    pTooltip="Remover imagem"
                    tooltipPosition="top"
                ></button>
            </div>
            <div [id]="getMapId(img)" class="map-container"></div>
        </div>
    </div>
</div>
